#!/bin/bash

OUTPUT_DIR=~/Dropbox/Public

DIST_NAME=BitSafe

if [ -z "$1" ]; then
	echo "usage: release <version>"
	exit 1
fi

function processfile {
        gpg -bs $1 || return $?
	cp $1 $TODIR
	mv $1.sig $TODIR
	return $?
}

function exiterr {
	echo "error, exiting."
	exit 1
}


if [ ! -d $OUTPUT_DIR ]; then
	echo "no output directory"
	exit 1
fi

BINARY_FILE_SRC=binary.hybrid.iso
UPDATE_FILE_SRC=binary/live/filesystem.squashfs

if [ ! -e $BINARY_FILE_SRC ] || [ ! -e $UPDATE_FILE_SRC ]; then
	echo "missing $BINARY_FILE_SRC or $UPDATE_FILE_SRC"
	exit 1
fi
TODIR=$OUTPUT_DIR/$1
test -d $TODIR || mkdir -p $TODIR
if [ ! -d $TODIR ]; then
        echo "no output directory"
        exit 1
fi

BINARY_FILE=$DIST_NAME\_V$1\_image.img
UPDATE_FILE=$DIST_NAME\_V$1\_update.zip

ln -s $BINARY_FILE_SRC "$BINARY_FILE" || exiterr
processfile "$BINARY_FILE" || exiterr
rm "$BINARY_FILE"

cd binary || exiterr 
#tar -czf ../live.tar.gz live || exiterr
zip -r ../"$UPDATE_FILE" live || exiterr
cd ..
processfile "$UPDATE_FILE" || exiterr
rm "$UPDATE_FILE" || exiterr

echo ""
echo "Calculating MD5 hash..."
cd $TODIR 
md5sum "$BINARY_FILE" "$UPDATE_FILE"
